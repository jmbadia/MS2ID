<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Annotate query spectra • MS2ID</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Annotate query spectra">
<meta property="og:description" content="MS2ID">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">MS2ID</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/MS2ID.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/annotate.html">Annotate query spectra</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/jmbadia/MS2ID/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="annotate_files/header-attrs-2.9/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Annotate query spectra</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/jmbadia/MS2ID/blob/master/vignettes/annotate.Rmd"><code>vignettes/annotate.Rmd</code></a></small>
      <div class="hidden name"><code>annotate.Rmd</code></div>

    </div>

    
    
<script type="text/javascript">
document.addEventListener("DOMContentLoaded", function() {
  document.querySelector("h1").className = "title";
});
</script><script type="text/javascript">
document.addEventListener("DOMContentLoaded", function() {
  var links = document.links;  
  for (var i = 0, linksLength = links.length; i < linksLength; i++)
    if (links[i].hostname != window.location.hostname)
      links[i].target = '_blank';
});
</script><p><strong>Authors</strong>: Josep M. Badia [aut, cre] (<a href="https://orcid.org/0000-0002-5704-1124" class="uri">https://orcid.org/0000-0002-5704-1124</a>)<br><strong>Last modified:</strong> 2021-09-27 19:37:55<br><strong>Compiled</strong>: Mon Sep 27 19:39:36 2021</p>
<p>*This vignette describe in detail the <code>annotate</code> function. It is advised a previous reading of the <a href="MS2ID.html">MS2ID introduction</a>.</p>
<div id="introduction" class="section level2">
<h2 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h2>
<p><code>annotate</code> is the MS2ID function that annotates MS/MS query spectra; every query spectrum is compared with a reference library, and compounds with a similar spectrum are listed. This function requires an MS2ID reference library, as described in <a href="MS2ID.html">MS2ID introduction</a>; next code recalls how to obtain it:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/EuracBiomedicalResearch/CompoundDb">CompoundDb</a></span><span class="op">)</span>
<span class="va">wrkDir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html">tempdir</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">## Locate the compounds file</span>
<span class="va">MoNAsubset</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"extdata/MoNAsubset.sdf.gz"</span>, package <span class="op">=</span> <span class="st">"MS2ID"</span><span class="op">)</span>
<span class="va">cmps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/CompoundDb/man/compound_tbl_sdf.html">compound_tbl_sdf</a></span><span class="op">(</span><span class="va">MoNAsubset</span><span class="op">)</span></code></pre></div>
<pre><code>## Warning: MoNa data can currently not be normalized and the compound table
## contains thus highly redundant data.</code></pre>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">spctr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/CompoundDb/man/msms_spectra_mona.html">msms_spectra_mona</a></span><span class="op">(</span><span class="va">MoNAsubset</span>, collapsed <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">spctr</span><span class="op">$</span><span class="va">predicted</span> <span class="op">&lt;-</span> <span class="cn">FALSE</span>
<span class="co">#configure metadata  </span>
<span class="va">metad</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>
        name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"source"</span>, <span class="st">"url"</span>, <span class="st">"source_version"</span>,<span class="st">"source_date"</span><span class="op">)</span>,
        value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"MoNA"</span>, <span class="st">"https://mona.fiehnlab.ucdavis.edu/downloads"</span>,
                  <span class="st">"v1"</span>, <span class="st">'07-09'</span><span class="op">)</span>
    <span class="op">)</span>
<span class="co">#obtain compdb object</span>
<span class="va">cmpdbDir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="va">wrkDir</span>, <span class="st">"cmpdbDir"</span><span class="op">)</span>
<span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/files2.html">dir.exists</a></span><span class="op">(</span><span class="va">cmpdbDir</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="va">file.remove</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span><span class="va">cmpdbDir</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span><span class="kw">else</span><span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/files2.html">dir.create</a></span><span class="op">(</span><span class="va">cmpdbDir</span><span class="op">)</span>
<span class="op">}</span>
<span class="va">db_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/CompoundDb/man/createCompDb.html">createCompDb</a></span><span class="op">(</span><span class="va">cmps</span>, metadata <span class="op">=</span> <span class="va">metad</span>, msms_spectra <span class="op">=</span> <span class="va">spctr</span>,
                        path <span class="op">=</span> <span class="va">cmpdbDir</span><span class="op">)</span>
<span class="va">cmpdb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/CompoundDb/man/CompDb.html">CompDb</a></span><span class="op">(</span><span class="va">db_file</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://jmbadia.github.io/MS2ID/index.html">MS2ID</a></span><span class="op">)</span>
<span class="va">MS2IDdirectory</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/createMS2ID.html">createMS2ID</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"MS2ID_annotVign"</span>, cmpdb <span class="op">=</span> <span class="va">cmpdb</span>,
                              overwrite <span class="op">=</span> <span class="cn">TRUE</span>, path <span class="op">=</span> <span class="va">wrkDir</span><span class="op">)</span></code></pre></div>
<p>The following example shows the basic usage of the function <code>annotate.</code> It takes advantage of tools developed in the <em><a href="https://bioconductor.org/packages/3.14/Spectra">Spectra</a></em> package <span class="citation">(Gatto, Rainer, and Gibb 2021)</span> to subset query spectra according to their retention time and MSLevel; please note that direct loading mzML files is also possible.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">utils</span>, <span class="va">Spectra</span>, <span class="va">MS2ID</span><span class="op">)</span>
<span class="va">queryFile</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"extdata/Met1.zip"</span>, package <span class="op">=</span> <span class="st">"MS2ID"</span><span class="op">)</span>
<span class="va">queryFolder</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="va">wrkDir</span>, <span class="st">"QRYspectra"</span><span class="op">)</span>
<span class="fu">utils</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/utils/unzip.html">unzip</a></span><span class="op">(</span><span class="va">queryFile</span>, exdir <span class="op">=</span> <span class="va">queryFolder</span><span class="op">)</span>
<span class="va">querySpectra</span> <span class="op">&lt;-</span> <span class="fu">Spectra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/Spectra.html">Spectra</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.files.html">dir</a></span><span class="op">(</span><span class="va">queryFolder</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>
<span class="va">querySpectra</span> <span class="op">&lt;-</span> <span class="va">querySpectra</span> <span class="op">%&gt;%</span>
  <span class="fu">Spectra</span><span class="fu">::</span><span class="fu">filterMsLevel</span><span class="op">(</span><span class="fl">2</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">Spectra</span><span class="fu">::</span><span class="fu">filterRt</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">400</span><span class="op">)</span><span class="op">)</span>
<span class="va">refLibrary</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/MS2ID.html">MS2ID</a></span><span class="op">(</span><span class="va">MS2IDdirectory</span><span class="op">)</span>
<span class="va">annotResult</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/annotate.html">annotate</a></span><span class="op">(</span>QRYdata <span class="op">=</span> <span class="va">querySpectra</span>, MS2ID <span class="op">=</span> <span class="va">refLibrary</span><span class="op">)</span></code></pre></div>
<p>The <code>annotate</code> function returns an <code>Annot</code> object.</p>
</div>
<div id="annot" class="section level2">
<h2 class="hasAnchor">
<a href="#annot" class="anchor"></a>Annot object</h2>
<p>This object stores the annotation so we can:</p>
<ul>
<li>Browse graphically the results with the <code>MS2IDgui</code> function.</li>
<li>Export all the data as an xlsx file by using the <code>export2xlsx</code> function.</li>
<li>Extract any content by using the following <em>getters</em> (custom functions to <em>get</em> the info).
<ul>
<li>
<code>hits()</code>: Returns a cross-reference data frame containing the annotation hits, the id of the spectra and compounds and:
<ul>
<li>
<em>propAdduct</em>: the proposed adduct that would match the query precursor mass with the neutral mass of the reference compound.</li>
<li>
<em>cmnMasses</em>: Number of fragments in common between the query and the reference spectrum</li>
</ul>
</li>
<li>
<code>qrySpectra()</code>: returns an <code>Spectra</code> object (<em><a href="https://bioconductor.org/packages/3.14/Spectra">Spectra</a></em> package) containing both successful query and consensus spectra (and their source spectra) (see <a href="#consensus">consensus spectra</a>).</li>
<li>
<code>refSpectra()</code>: returns an <code>Spectra</code> object (<em><a href="https://bioconductor.org/packages/3.14/Spectra">Spectra</a></em> package) with the reference spectra present in the <em>hits</em> table.</li>
<li>
<code>refCompound()</code>: returns a data frame containing metadata of the reference compounds present in the <em>hits</em> table.</li>
<li>
<code>infoAnnotation()</code>: variables used on the <code>annotate</code> function.</li>
</ul>
</li>
</ul>
<p>In the example below, we use <em><a href="https://bioconductor.org/packages/3.14/Spectra">Spectra</a></em> tools to browse the annotation results, although it is more advisable to use the visual browsing provided by the <code>MS2IDgui</code> function.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#merge hits and compound info</span>
<span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html">merge</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu">hits</span><span class="op">(</span><span class="va">annotResult</span><span class="op">)</span>, y <span class="op">=</span> <span class="fu">refCompound</span><span class="op">(</span><span class="va">annotResult</span><span class="op">)</span>, 
                by.x <span class="op">=</span> <span class="st">"idREFcomp"</span>, by.y <span class="op">=</span> <span class="st">"id"</span>, all.y <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span></code></pre></div>
<pre><code>##   idREFcomp    cosine idREFspect idQRYspect propAdduct cmnMasses ID_db
## 1         1 0.9296013         32       1787        M+H         3  MoNA
## 2         1 0.8735071         29       1829        M+H         3  MoNA
## 3         1 0.9279620         29       1787        M+H         2  MoNA
## 4         1 0.9712797         30       1858        M+H         3  MoNA
## 5         1 0.8929630         33       1829        M+H         4  MoNA
## 6         1 0.8742057         35       1829        M+H         3  MoNA
##        name    formula exactmass                    inchikey smiles
## 1 Bilirubin C33H36N4O6  584.2635 BPYKTIZUTYGOLE-IFADSCNNSA-N     NA
## 2 Bilirubin C33H36N4O6  584.2635 BPYKTIZUTYGOLE-IFADSCNNSA-N     NA
## 3 Bilirubin C33H36N4O6  584.2635 BPYKTIZUTYGOLE-IFADSCNNSA-N     NA
## 4 Bilirubin C33H36N4O6  584.2635 BPYKTIZUTYGOLE-IFADSCNNSA-N     NA
## 5 Bilirubin C33H36N4O6  584.2635 BPYKTIZUTYGOLE-IFADSCNNSA-N     NA
## 6 Bilirubin C33H36N4O6  584.2635 BPYKTIZUTYGOLE-IFADSCNNSA-N     NA</code></pre>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RforMassSpectrometry/Spectra">Spectra</a></span><span class="op">)</span>
<span class="co">#Subset spectra and metadata considering first hit query spectra</span>
<span class="va">idQRYspect_1</span> <span class="op">&lt;-</span> <span class="va">result</span><span class="op">$</span><span class="va">idQRYspect</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>
<span class="va">result_1</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">result</span>, <span class="va">idQRYspect</span>  <span class="op">==</span> <span class="va">idQRYspect_1</span><span class="op">)</span>
<span class="va">qrySpct_1</span> <span class="op">&lt;-</span> <span class="fu">qrySpectra</span><span class="op">(</span><span class="va">annotResult</span><span class="op">)</span>
<span class="va">qrySpct_1</span> <span class="op">&lt;-</span> <span class="va">qrySpct_1</span><span class="op">[</span><span class="va">qrySpct_1</span><span class="op">$</span><span class="va">id</span> <span class="op">%in%</span> <span class="va">result_1</span><span class="op">$</span><span class="va">idQRYspect</span><span class="op">]</span>
<span class="va">refSpct_1</span> <span class="op">&lt;-</span> <span class="fu">refSpectra</span><span class="op">(</span><span class="va">annotResult</span><span class="op">)</span>
<span class="va">refSpct_1</span> <span class="op">&lt;-</span> <span class="va">refSpct_1</span><span class="op">[</span><span class="va">refSpct_1</span><span class="op">$</span><span class="va">id</span> <span class="op">%in%</span> <span class="va">result_1</span><span class="op">$</span><span class="va">idREFspect</span><span class="op">]</span>
<span class="co">#compare query spectrum with its first hit reference spectrum</span>
<span class="va">refSpct_draw</span> <span class="op">&lt;-</span> <span class="va">refSpct_1</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>
<span class="va">refSpct_draw</span><span class="op">$</span><span class="va">intensity</span> <span class="op">&lt;-</span> <span class="va">refSpct_draw</span><span class="op">$</span><span class="va">intensity</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">refSpct_draw</span><span class="op">$</span><span class="va">intensity</span><span class="op">)</span>
<span class="va">qrySpct_1</span><span class="op">$</span><span class="va">intensity</span> <span class="op">&lt;-</span> <span class="va">qrySpct_1</span><span class="op">$</span><span class="va">intensity</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">qrySpct_1</span><span class="op">$</span><span class="va">intensity</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/spectra-plotting.html">plotSpectraMirror</a></span><span class="op">(</span><span class="va">qrySpct_1</span>, <span class="va">refSpct_draw</span><span class="op">)</span></code></pre></div>
<p><img src="annotate_files/figure-html/getters-1.png" width="700"></p>
</div>
<div id="consensus" class="section level2">
<h2 class="hasAnchor">
<a href="#consensus" class="anchor"></a>Consensus spectra</h2>
<p>As a default, <code>annotate</code> function tries to summarize adjacent MS/MS spectra into consensus spectra: the resulting consensus spectra will be annotated instead of the query spectra that summarizes (along with the query spectra non able to be consensued). This strategy diminishes artifacts and noise and reduce significantly the annotation time.<br>
A group of <strong>adjacent</strong> query spectra is considered <em>source</em> for a consensus spectrum when all of them have the same precursor mass, collision energy and polarity. Also, every query spectrum must be similar (cosine &gt; <code>consCos</code> argument) to the apex spectrum of the group. The resulting consensus spectrum will be formed by the fragments present in the majority of the source query spectra (ratio determined by the <code>consComm</code> argument).<br>
The final <code>annot</code> object will contain not only the query spectra and the consensus spectra that succeeded in the annotation (i.e. with hits), but also the query spectra used to form the successful consensus spectra. Although it is recommended to use the MS2IDgui feature to elucidate the nature of the query spectra, it is also possible to check it by analyzing some of the variables contained in the <code>annot</code> object.</p>
<ul>
<li>When the spectrum is a consensus spectrum, <em>spectrumId_CONS</em> and <em>rtime_CONS</em> variables show the id and the retention time of its source query spectra.</li>
<li>
<em>rol</em> is an integer that makes explicit the nature of the spectrum:
<ul>
<li>1: query spectrum not grouped so it does not form consensus.<br>
</li>
<li>2: query spectrum grouped but not similar to the apex spectrum; it does not form consensus.<br>
</li>
<li>3: query spectrum source for a consensus spectrum.<br>
</li>
<li>4: consensus spectrum.</li>
</ul>
</li>
</ul>
<p>The algorithm will not annotate the spectra with rol=3.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">qrySpct</span> <span class="op">&lt;-</span> <span class="fu">qrySpectra</span><span class="op">(</span><span class="va">annotResult</span><span class="op">)</span>
<span class="co">#shor query data concerning consensus formation</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fu">spectraData</span><span class="op">(</span><span class="va">qrySpct</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"id"</span>, <span class="st">"spectrumId_CONS"</span>, <span class="st">"rtime_CONS"</span>, <span class="st">"rol"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## DataFrame with 6 rows and 4 columns
##          id        spectrumId_CONS             rtime_CONS       rol
##   &lt;integer&gt;            &lt;character&gt;            &lt;character&gt; &lt;integer&gt;
## 1      1775 scanId=339841, scanI.. 339.83299999998, 341..         4
## 2      1787 scanId=101609, scanI.. 101.601, 103.3339999..         4
## 3      1799 scanId=362352, scanI.. 362.34400000002, 364..         4
## 4      1817 scanId=340041, scanI.. 340.03300000002, 341..         4
## 5      1829 scanId=100071, scanI.. 100.06300000002, 101..         4
## 6      1831 scanId=302432, scanI.. 302.424, 304.161, 30..         4</code></pre>
</div>
<div id="subsetting-the-reference-library" class="section level2">
<h2 class="hasAnchor">
<a href="#subsetting-the-reference-library" class="anchor"></a>Subsetting the reference library</h2>
<p>In annotation, subsetting the reference library not only reduces the computing time significantly -by taking advantage of the MS2ID backend and the fragments index: it also prunes the result and cuts off non-sense hits. For example, the <code>cmnFrags = (m, n)</code> argument limits the reference spectra so that reference spectra and query spectra have at least m peaks in common among their top n most intense peaks.<br>
In addition, the <code>cmnPrecMass</code> argument limits the reference spectra to those with the same precursor mass as the query spectrum. On the other hand, <code>cmnNeutralMass</code> limits reference spectra to those with a neutral mass plausible with the query precursor (considering all possible adducts).</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>annotResult <span class="ot">&lt;-</span> <span class="fu">annotate</span>(<span class="at">QRYdir =</span> queryDir, <span class="at">MS2ID =</span> refLibrary, </span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>                        <span class="at">cmnFrags =</span> (<span class="dv">3</span>, <span class="dv">5</span>),</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>                        <span class="at">cmnPrecMass =</span> <span class="cn">TRUE</span>, <span class="at">cmnNeutralMass =</span> <span class="cn">TRUE</span>, </span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>                        <span class="at">cmnPolarity =</span> <span class="cn">TRUE</span>, <span class="at">nature =</span> <span class="st">"experimental"</span>)</span></code></pre></div>
<p>Other arguments subset the reference spectra according to their polarization or experimental nature (<code>cmnPolarity</code> and <code>predicted</code>, respectively).</p>
</div>
<div id="annotation-with-different-metrics" class="section level2">
<h2 class="hasAnchor">
<a href="#annotation-with-different-metrics" class="anchor"></a>Annotation with different metrics</h2>
<p>As a default, the annotate function uses cosine similarity as a metric to compare two spectra; its default threshold value to beat to consider the comparison a hit is 0.8.<br>
The function also allows the simultaneous calculation of different metrics. In that case, a spectrum comparison is considered a hit when at least one of the metrics exceeds its threshold value. <strong>Note that <em>to beat</em> a threshold value has a different meaning depending on the metric</strong>: <em>topsoe</em> and <em>squared_chord</em> metrics return a lower number when the spectra are more similar so, unlike the rest, a hit will occur when the returned value is lower than its threshold.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">annotResult</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/annotate.html">annotate</a></span><span class="op">(</span>QRYdata <span class="op">=</span> <span class="va">querySpectra</span>, MS2ID <span class="op">=</span> <span class="va">refLibrary</span>,
                        metrics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"fidelity"</span>, <span class="st">"cosine"</span>, <span class="st">"topsoe"</span><span class="op">)</span>,
                        metricsThresh <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.6</span>, <span class="fl">0.8</span>, <span class="fl">0.6</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fu">MS2ID</span><span class="fu">::</span><span class="fu">hits</span><span class="op">(</span><span class="va">annotResult</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>##         fidelity    cosine     topsoe idREFspect idQRYspect idREFcomp
## 1775.1 0.6182551 0.2691026 0.68745142        170       1775        10
## 1775.2 0.9486782 0.9867201 0.08079319        173       1775        10
## 1775.3 0.9750072 0.9981363 0.03686771        174       1775        10
## 1775.4 0.9849112 0.9994530 0.02179557        175       1775        10
## 1775.5 0.9070347 0.9408979 0.16563675        176       1775        10
## 1775.6 0.7294529 0.5787374 0.48779452        177       1775        10
##        propAdduct cmnMasses
## 1775.1        M+H         6
## 1775.2        M+H         4
## 1775.3        M+H         3
## 1775.4        M+H         5
## 1775.5        M+H         5
## 1775.6        M+H         5</code></pre>
<p>Moreover, <strong>the user can define its own metric</strong> by declaring a function as an argument; in the following example, <code>foo</code> function uses cosine+1 as a distance metric.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">foo</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">finalMatrix</span><span class="op">)</span><span class="op">{</span>
  <span class="va">vector1</span> <span class="op">&lt;-</span> <span class="va">finalMatrix</span><span class="op">[</span><span class="fl">1</span>,<span class="op">]</span>
  <span class="va">vector2</span> <span class="op">&lt;-</span> <span class="va">finalMatrix</span><span class="op">[</span><span class="fl">2</span>,<span class="op">]</span>
  <span class="va">CosplusOne</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/message.html">suppressMessages</a></span><span class="op">(</span>
    <span class="fu">philentropy</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/philentropy/man/distance.html">distance</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">vector1</span>, <span class="va">vector2</span><span class="op">)</span>, method <span class="op">=</span> <span class="st">"cosine"</span><span class="op">)</span>
    <span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">CosplusOne</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"CosplusOne"</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">CosplusOne</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">annotResult</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/annotate.html">annotate</a></span><span class="op">(</span>QRYdata <span class="op">=</span> <span class="va">querySpectra</span>, MS2ID <span class="op">=</span> <span class="va">refLibrary</span>,
                        metrics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"cosine"</span><span class="op">)</span>, metricsThresh <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.8</span><span class="op">)</span>,
                        metricFUN <span class="op">=</span> <span class="va">foo</span>, metricFUNThresh <span class="op">=</span> <span class="fl">1.8</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fu">MS2ID</span><span class="fu">::</span><span class="fu">hits</span><span class="op">(</span><span class="va">annotResult</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>##            cosine metricFunc.CosplusOne idREFspect idQRYspect idREFcomp
## 1775.2  0.9867201              1.986720        173       1775        10
## 1775.3  0.9981363              1.998136        174       1775        10
## 1775.4  0.9994530              1.999453        175       1775        10
## 1775.5  0.9408979              1.940898        176       1775        10
## 1775.9  0.9972315              1.997231        180       1775        10
## 1775.10 0.9994336              1.999434        181       1775        10
##         propAdduct cmnMasses
## 1775.2         M+H         4
## 1775.3         M+H         3
## 1775.4         M+H         5
## 1775.5         M+H         5
## 1775.9         M+H         2
## 1775.10        M+H         5</code></pre>
</div>
<div id="references" class="section level2 unnumbered">
<h2 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h2>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-Spectra" class="csl-entry">
Gatto, Laurent, Johannes Rainer, and Sebastian Gibb. 2021. <em>Spectra: Spectra Infrastructure for Mass Spectrometry Data</em>. <a href="https://github.com/RforMassSpectrometry/Spectra">https://github.com/RforMassSpectrometry/Spectra</a>.
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Josep M. Badia.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
